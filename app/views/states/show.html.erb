<div class="state-show">
  <% if @after_close %>
    <div class="state-close-success">
      <div class="success-icon">
        <i class="fas fa-heart"></i>
      </div>
      <h2>Conversation terminée</h2>
      <p>Merci d'avoir partagé ce que tu ressens. Voici un résumé de ton état émotionnel.</p>
    </div>
  <% end %>

  <div class="state-show-header">
    <% unless params[:iframe] %>
      <%= link_to (@after_close ? chats_path : states_path), class: "back-link" do %>
        <i class="fas fa-arrow-left"></i>
      <% end %>
    <% end %>
    <div class="header-content">
      <h1>Mon état</h1>
      <div class="date"><%= l(@state.created_at, format: :long) %></div>
    </div>
  </div>

  <div class="state-detail-card">
    <%# Résumé principal - toujours affiché si au moins un élément existe %>
    <% if @state.pain_level.present? || @state.emotion_label.present? || @state.grief_stage.present? || @state.time_of_day.present? || @score_diff.present? %>
      <div class="state-summary">
        <% if @state.pain_level.present? %>
          <div class="summary-item">
            <% pain = @state.pain_level %>
            <div class="summary-value">
              <span class="pain-badge <%= pain <= 3 ? 'low' : pain <= 6 ? 'medium' : 'high' %>">
                <%= pain %>/10
              </span>
            </div>
            <div class="summary-label">Douleur</div>
          </div>
        <% end %>

        <% if @state.emotion_label.present? %>
          <div class="summary-item">
            <div class="summary-value"><%= @state.emotion_label.humanize %></div>
            <div class="summary-label">Émotion</div>
          </div>
        <% end %>

        <% if @state.grief_stage.present? %>
          <div class="summary-item">
            <div class="summary-value"><%= @state.grief_stage.name %></div>
            <div class="summary-label">Phase</div>
          </div>
        <% end %>

        <% if @state.time_of_day.present? %>
          <div class="summary-item">
            <div class="summary-value"><%= @state.time_of_day.humanize %></div>
            <div class="summary-label">Moment</div>
          </div>
        <% end %>

        <% if @score_diff.present? %>
          <div class="summary-item">
            <div class="summary-value">
              <span class="score-diff-badge <%= @score_diff > 0 ? 'positive' : 'neutral' %>">
                <%= @score_diff > 0 ? "+#{@score_diff}" : @score_diff %>%
              </span>
            </div>
            <div class="summary-label">Progression</div>
          </div>
        <% end %>
      </div>
    <% end %>

    <%# Résumé de l'analyse (si disponible) %>
    <% if @state.analysis&.resume.present? %>
      <div class="detail-section analysis-resume">
        <div class="section-title">
          <i class="fas fa-brain"></i>
          Analyse
        </div>
        <div class="resume-box">
          <%= @state.analysis.resume %>
        </div>
        <% if @state.analysis.score.present? %>
          <div class="score-display">
            <span class="score-label">Progression</span>
            <div class="score-bar">
              <div class="score-fill" style="width: <%= @state.analysis.score %>%"></div>
            </div>
            <span class="score-value"><%= @state.analysis.score %>%</span>
          </div>
        <% end %>
      </div>
    <% end %>

    <%# Ce que l'utilisateur a exprimé %>
    <% if @state.raw_input.present? %>
      <div class="detail-section">
        <div class="section-title">Ce que tu as exprimé</div>
        <div class="raw-input-box">
          <%= @state.raw_input %>
        </div>
      </div>
    <% end %>

    <%# Sentiment principal %>
    <% if @state.main_sentiment.present? %>
      <div class="detail-section">
        <div class="section-title">Sentiment principal</div>
        <p><%= @state.main_sentiment %></p>
      </div>
    <% end %>

    <%# Grille de détails - seulement si au moins un élément pertinent existe %>
    <% has_trigger = relevant_value?(@state.trigger_source) %>
    <% has_ex_contact = relevant_value?(@state.ex_contact_frequency) %>
    <% has_reunion = !@state.considered_reunion.nil? %>
    <% has_ruminating = relevant_value?(@state.ruminating_frequency) %>
    <% has_sleep = relevant_value?(@state.sleep_quality) %>
    <% has_support = relevant_value?(@state.support_level) %>
    <% has_drugs = relevant_value?(@state.drugs) && @state.drugs != "aucun" %>

    <% details_present = has_trigger || has_ex_contact || has_reunion || has_ruminating || has_sleep || has_support || has_drugs %>

    <% if details_present %>
      <div class="detail-section">
        <div class="section-title">Détails</div>
        <div class="details-grid">
          <% if has_trigger %>
            <div class="detail-item">
              <div class="detail-label">Déclencheur</div>
              <div class="detail-value"><%= @state.trigger_source.humanize %></div>
            </div>
          <% end %>

          <% if has_ex_contact %>
            <div class="detail-item">
              <div class="detail-label">Contact avec l'ex</div>
              <div class="detail-value"><%= @state.ex_contact_frequency.humanize %></div>
            </div>
          <% end %>

          <% if has_reunion %>
            <div class="detail-item">
              <div class="detail-label">Réconciliation envisagée</div>
              <div class="detail-value"><%= @state.considered_reunion ? "Oui" : "Non" %></div>
            </div>
          <% end %>

          <% if has_ruminating %>
            <div class="detail-item">
              <div class="detail-label">Rumination</div>
              <div class="detail-value"><%= @state.ruminating_frequency.humanize %></div>
            </div>
          <% end %>

          <% if has_sleep %>
            <div class="detail-item">
              <div class="detail-label">Qualité du sommeil</div>
              <div class="detail-value"><%= @state.sleep_quality.humanize %></div>
            </div>
          <% end %>

          <% if has_support %>
            <div class="detail-item">
              <div class="detail-label">Niveau de soutien</div>
              <div class="detail-value"><%= @state.support_level.humanize %></div>
            </div>
          <% end %>

          <% if has_drugs %>
            <div class="detail-item">
              <div class="detail-label">Consommation</div>
              <div class="detail-value"><%= @state.drugs.humanize %></div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# Changements d'habitudes %>
    <% if @state.habits_changed.present? %>
      <div class="detail-section">
        <div class="section-title">Changements d'habitudes</div>
        <p><%= @state.habits_changed %></p>
      </div>
    <% end %>

    <%# Archétype détecté pour cet échange %>
    <div class="detail-section archetype-section">
      <div class="section-title">
        <i class="fas fa-user-circle"></i>
        Ton profil relationnel
      </div>
      <% if @state.profil_relationnel.present? %>
        <div class="archetype-badge">
          <%= @state.profil_relationnel %>
        </div>
      <% else %>
        <div class="archetype-undetermined">
          <i class="fas fa-question-circle"></i>
          <span>Impossible de déterminer ton archétype, notre échange a été trop court !</span>
        </div>
      <% end %>
    </div>
  </div>

  <% unless params[:iframe] %>
    <div class="quiz-actions mt-4">
      <%= link_to states_path, class: "btn btn-secondary" do %>
        <i class="fas fa-list"></i> Retour à l'historique
      <% end %>
      <%= link_to new_state_path, class: "btn btn-primary" do %>
        <i class="fas fa-plus"></i> Nouvel état
      <% end %>
    </div>
  <% end %>
</div>
