<div class="dashboard-container">
  <!-- Logo -->
  <div class="dashboard-logo">
    <h1 class="haven-logo">HAVEN</h1>
  </div>

  <!-- Greeting -->
  <div class="dashboard-greeting">
    <h2>Bonjour <%= current_user.username || current_user.email.split('@').first %></h2>
  </div>

  <!-- 3 Stats Cards -->
  <div class="dashboard-cards">
    <div class="stat-card">
      <div class="stat-value"><%= @days_since_breakup %></div>
      <div class="stat-label">jours depuis la rupture</div>
    </div>

    <div class="stat-card sentiment-card">
      <div class="stat-sentiment"><%= @latest_state&.main_sentiment || "Pas encore d'échange" %></div>
      <div class="stat-label">Comment tu te sentais lors de notre dernier échange</div>
    </div>

    <div class="stat-card">
      <div class="stat-value"><%= @total_chats %></div>
      <div class="stat-label">échanges</div>
    </div>
  </div>

  <!-- Frise des 5 étapes du deuil -->
  <div class="grief-timeline-card">
    <div class="grief-timeline">
      <div class="grief-progress-bar">
        <div class="grief-progress-fill" style="width: <%= @current_score %>%;"></div>
        <div class="grief-cursor <%= 'clickable' if @latest_analysis %>"
             id="score-cursor"
             style="left: <%= @current_score %>%;"
             <% if @latest_analysis %>
             data-analysis-score="<%= @latest_analysis.score %>"
             data-analysis-resume="<%= @latest_analysis.resume %>"
             data-analysis-date="<%= l(@latest_analysis.created_at, format: :long) %>"
             <% end %>>
          <span class="cursor-score"><%= @current_score %></span>
        </div>
      </div>

      <div class="grief-stages">
        <% @grief_stages.each_with_index do |stage, index| %>
          <% stage_position = (index * 25) %>
          <% is_current = @latest_state && @latest_state.grief_stage_id == stage.id %>
          <div class="grief-stage-item <%= 'active' if is_current %>"
               data-stage-id="<%= stage.id %>"
               data-stage-name="<%= stage.name %>"
               data-stage-desc="<%= stage.description %>"
               style="left: <%= stage_position %>%;">
            <div class="stage-dot"></div>
            <span class="stage-name"><%= stage.name %></span>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Modal pour afficher la description de l'étape -->
  <div class="grief-modal" id="grief-modal" style="display: none;">
    <div class="grief-modal-content">
      <button class="grief-modal-close" id="grief-modal-close">&times;</button>
      <h3 class="grief-modal-title" id="grief-modal-title"></h3>
      <p class="grief-modal-desc" id="grief-modal-desc"></p>
    </div>
  </div>

  <!-- Modal pour afficher le résumé de l'analyse -->
  <div class="analysis-modal" id="analysis-modal" style="display: none;">
    <div class="analysis-modal-content">
      <button class="analysis-modal-close" id="analysis-modal-close">&times;</button>
      <div class="analysis-modal-header">
        <div class="analysis-score-badge" id="analysis-modal-score"></div>
        <span class="analysis-date" id="analysis-modal-date"></span>
      </div>
      <h3 class="analysis-modal-title">Dernière analyse</h3>
      <p class="analysis-modal-resume" id="analysis-modal-resume"></p>
    </div>
  </div>

  <!-- Chat Input Bar -->
  <div class="chat-input-container">
    <%= form_with url: chats_path, method: :post, class: "chat-input-form" do |f| %>
      <div class="chat-input-wrapper">
        <%= f.text_field :message, placeholder: "Démarrer un échange...", class: "chat-input-field", autocomplete: "off" %>
        <button type="button" class="chat-mic-btn" id="mic-btn">
          <i class="fa-solid fa-microphone"></i>
        </button>
        <button type="submit" class="chat-send-btn">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
    <% end %>
  </div>
</div>

<script>
document.addEventListener('turbo:load', function() {
  // Microphone
  const micBtn = document.getElementById('mic-btn');
  const inputField = document.querySelector('.chat-input-field');

  if (micBtn && 'webkitSpeechRecognition' in window) {
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'fr-FR';
    recognition.continuous = false;
    recognition.interimResults = false;

    micBtn.addEventListener('click', function() {
      micBtn.classList.add('listening');
      recognition.start();
    });

    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript;
      inputField.value = transcript;
      micBtn.classList.remove('listening');
    };

    recognition.onerror = function() {
      micBtn.classList.remove('listening');
    };

    recognition.onend = function() {
      micBtn.classList.remove('listening');
    };
  } else if (micBtn) {
    micBtn.style.display = 'none';
  }

  // Modal des étapes du deuil
  const stageItems = document.querySelectorAll('.grief-stage-item');
  const griefModal = document.getElementById('grief-modal');
  const griefModalTitle = document.getElementById('grief-modal-title');
  const griefModalDesc = document.getElementById('grief-modal-desc');
  const griefModalClose = document.getElementById('grief-modal-close');

  if (griefModal) {
    stageItems.forEach(function(item) {
      item.addEventListener('click', function() {
        const name = this.dataset.stageName;
        const desc = this.dataset.stageDesc;
        griefModalTitle.textContent = name;
        griefModalDesc.textContent = desc;
        griefModal.style.display = 'flex';
      });
    });

    griefModalClose.addEventListener('click', function() {
      griefModal.style.display = 'none';
    });

    griefModal.addEventListener('click', function(e) {
      if (e.target === griefModal) {
        griefModal.style.display = 'none';
      }
    });
  }

  // Modal de l'analyse (clic sur le score)
  const scoreCursor = document.getElementById('score-cursor');
  const analysisModal = document.getElementById('analysis-modal');
  const analysisModalScore = document.getElementById('analysis-modal-score');
  const analysisModalDate = document.getElementById('analysis-modal-date');
  const analysisModalResume = document.getElementById('analysis-modal-resume');
  const analysisModalClose = document.getElementById('analysis-modal-close');

  if (scoreCursor && analysisModal && scoreCursor.dataset.analysisResume) {
    scoreCursor.addEventListener('click', function() {
      const score = this.dataset.analysisScore;
      const resume = this.dataset.analysisResume;
      const date = this.dataset.analysisDate;

      analysisModalScore.textContent = score + '/100';
      analysisModalDate.textContent = date;
      analysisModalResume.textContent = resume;
      analysisModal.style.display = 'flex';
    });

    analysisModalClose.addEventListener('click', function() {
      analysisModal.style.display = 'none';
    });

    analysisModal.addEventListener('click', function(e) {
      if (e.target === analysisModal) {
        analysisModal.style.display = 'none';
      }
    });
  }
});
</script>
