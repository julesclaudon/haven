<div class="analyse-container">
  <div class="analyse-header">
    <h1>Mon Analyse</h1>
  </div>

  <!-- Section Archétype : 2 cards côte à côte -->
  <% if current_user.archetype_unlocked? && @archetype %>
    <div class="archetype-section">
      <div class="archetype-image-card">
        <div class="archetype-image-wrapper">
          <% archetype_icon = case @archetype.archetype_name
             when "Le Chevalier" then "fa-shield-halved"
             when "Le Sauveur" then "fa-hand-holding-heart"
             when "L'Indépendant" then "fa-person-walking"
             when "Le Romantique" then "fa-heart"
             when "L'Anxieux" then "fa-cloud-bolt"
             when "Le Caméléon" then "fa-masks-theater"
             when "Le Perfectionniste" then "fa-bullseye"
             when "Le Fusionnel" then "fa-link"
             when "Le Stratège" then "fa-chess"
             when "L'Intense" then "fa-fire"
             else "fa-user"
             end %>
          <i class="fa-solid <%= archetype_icon %> archetype-icon"></i>
        </div>
        <h3 class="archetype-name"><%= @archetype.archetype_name %></h3>
      </div>
      <div class="archetype-desc-card">
        <div class="archetype-desc-header">
          <i class="fa-solid fa-masks-theater"></i>
          <span>Ton archétype relationnel</span>
        </div>
        <p class="archetype-description"><%= @archetype.archetype_desc %></p>
      </div>
    </div>
  <% else %>
    <% progress = current_user.archetype_unlock_progress %>
    <div class="archetype-locked-section">
      <div class="archetype-locked-card">
        <div class="locked-icon">
          <i class="fa-solid fa-lock"></i>
        </div>
        <h3>Ton archétype relationnel</h3>
        <p class="locked-subtitle">Continue à échanger avec Haven pour débloquer ton profil !</p>

        <div class="unlock-progress">
          <div class="progress-item">
            <div class="progress-header">
              <i class="fa-solid fa-comments"></i>
              <span>Échanges terminés</span>
            </div>
            <div class="progress-bar-wrapper">
              <div class="progress-bar" style="width: <%= (progress[:chats_progress].to_f / progress[:chats_required] * 100).round %>%;"></div>
            </div>
            <div class="progress-text"><%= progress[:chats_progress] %> / <%= progress[:chats_required] %></div>
          </div>

          <div class="progress-item">
            <div class="progress-header">
              <i class="fa-solid fa-calendar-days"></i>
              <span>Jours d'utilisation</span>
            </div>
            <div class="progress-bar-wrapper">
              <div class="progress-bar" style="width: <%= (progress[:days_progress].to_f / progress[:days_required] * 100).round %>%;"></div>
            </div>
            <div class="progress-text"><%= progress[:days_progress] %> / <%= progress[:days_required] %> jours</div>
          </div>
        </div>

        <% dominant = current_user.computed_dominant_archetype %>
        <% if dominant %>
          <div class="archetype-preview">
            <i class="fa-solid fa-eye"></i>
            <span>Tendance actuelle : <strong><%= dominant %></strong></span>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Insights Cards -->
  <div class="insights-section">
    <h2 class="insights-title">Tes insights</h2>

    <div class="insights-grid">
      <!-- Évolution de la douleur -->
      <% if @pain_trend %>
        <div class="insight-card <%= @pain_trend < 0 ? 'positive' : @pain_trend > 0 ? 'negative' : 'neutral' %>">
          <div class="insight-icon">
            <i class="fa-solid <%= @pain_trend < 0 ? 'fa-arrow-trend-down' : @pain_trend > 0 ? 'fa-arrow-trend-up' : 'fa-minus' %>"></i>
          </div>
          <div class="insight-content">
            <div class="insight-value"><%= @pain_trend.abs %> pts</div>
            <div class="insight-label">
              <% if @pain_trend < 0 %>
                Ta douleur a diminué
              <% elsif @pain_trend > 0 %>
                Ta douleur a augmenté
              <% else %>
                Ta douleur est stable
              <% end %>
            </div>
            <div class="insight-detail">De <%= @first_pain %>/10 à <%= @last_pain %>/10</div>
          </div>
        </div>
      <% end %>

      <!-- Progression du score -->
      <% if @score_trend %>
        <div class="insight-card <%= @score_trend > 0 ? 'positive' : @score_trend < 0 ? 'negative' : 'neutral' %>">
          <div class="insight-icon">
            <i class="fa-solid <%= @score_trend > 0 ? 'fa-arrow-trend-up' : @score_trend < 0 ? 'fa-arrow-trend-down' : 'fa-minus' %>"></i>
          </div>
          <div class="insight-content">
            <div class="insight-value">+<%= @score_trend.abs %> pts</div>
            <div class="insight-label">
              <% if @score_trend > 0 %>
                Ton score progresse
              <% elsif @score_trend < 0 %>
                Ton score a baissé
              <% else %>
                Ton score est stable
              <% end %>
            </div>
            <div class="insight-detail">De <%= @first_score %> à <%= @last_score %>/100</div>
          </div>
        </div>
      <% end %>

      <!-- Top déclencheur -->
      <% if @top_triggers.any? %>
        <div class="insight-card neutral">
          <div class="insight-icon">
            <i class="fa-solid fa-bolt"></i>
          </div>
          <div class="insight-content">
            <div class="insight-value"><%= @top_triggers.keys.first&.humanize %></div>
            <div class="insight-label">Ton déclencheur principal</div>
            <div class="insight-detail">
              <% @top_triggers.first(3).each do |trigger, count| %>
                <span class="trigger-tag"><%= trigger.humanize %> (<%= count %>)</span>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Moment difficile -->
      <% if @worst_time %>
        <div class="insight-card neutral">
          <div class="insight-icon">
            <i class="fa-solid fa-clock"></i>
          </div>
          <div class="insight-content">
            <div class="insight-value"><%= @worst_time.humanize %></div>
            <div class="insight-label">Ton moment le plus difficile</div>
            <div class="insight-detail">
              <% @time_of_day_stats.each do |time, count| %>
                <span class="time-tag"><%= time.humanize %>: <%= count %></span>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Contact avec l'ex -->
      <% if @first_contact && @last_contact && @first_contact != @last_contact %>
        <div class="insight-card positive">
          <div class="insight-icon">
            <i class="fa-solid fa-phone-slash"></i>
          </div>
          <div class="insight-content">
            <div class="insight-value"><%= @last_contact.humanize %></div>
            <div class="insight-label">Contact avec ton ex</div>
            <div class="insight-detail">Passé de "<%= @first_contact.humanize %>" à "<%= @last_contact.humanize %>"</div>
          </div>
        </div>
      <% end %>

      <!-- Réconciliation -->
      <% if @reunion_percentage %>
        <div class="insight-card <%= @reunion_percentage >= 50 ? 'positive' : 'neutral' %>">
          <div class="insight-icon">
            <i class="fa-solid fa-heart-crack"></i>
          </div>
          <div class="insight-content">
            <div class="insight-value"><%= @reunion_percentage %>%</div>
            <div class="insight-label">Tu n'envisages plus la réconciliation</div>
            <div class="insight-detail">Sur <%= @reunion_total %> réflexions</div>
          </div>
        </div>
      <% end %>

      <!-- Contexte relation -->
      <% if @relation_duration && @days_since_breakup %>
        <div class="insight-card neutral">
          <div class="insight-icon">
            <i class="fa-solid fa-calendar-days"></i>
          </div>
          <div class="insight-content">
            <div class="insight-value"><%= @relation_duration %> mois</div>
            <div class="insight-label">Durée de ta relation</div>
            <div class="insight-detail"><%= @days_since_breakup %> jours depuis la rupture</div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Graphique des émotions -->
  <div class="emotions-chart-card">
    <h3 class="chart-title">Tes émotions dominantes</h3>
    <p class="chart-subtitle">Basé sur tes 20 derniers états</p>

    <% if @top_emotions.any? %>
      <div class="emotions-bars">
        <% @top_emotions.each do |emotion, percentage| %>
          <div class="emotion-bar-item">
            <div class="emotion-label"><%= emotion.humanize %></div>
            <div class="emotion-bar-wrapper">
              <div class="emotion-bar" style="width: <%= percentage %>%;" data-percentage="<%= percentage %>"></div>
            </div>
            <div class="emotion-percentage"><%= percentage %>%</div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="emotions-empty">
        <i class="fa-solid fa-chart-simple"></i>
        <p>Pas encore assez de données pour analyser tes émotions.</p>
      </div>
    <% end %>
  </div>

  <!-- Historique des analyses -->
  <% if @analyses.any? %>
    <div class="analyses-history-card">
      <h3>Historique des analyses</h3>
      <ul class="analyses-list">
        <% @analyses.limit(5).each do |analysis| %>
          <li class="analysis-item">
            <%= link_to analysis_path(analysis), class: "analysis-link" do %>
              <div class="analysis-info">
                <span class="analysis-score"><%= analysis.score %>/100</span>
                <span class="analysis-date"><%= analysis.created_at.strftime('%d/%m/%Y') %></span>
              </div>
              <i class="fa-solid fa-chevron-right"></i>
            <% end %>
          </li>
        <% end %>
      </ul>
    </div>
  <% end %>
</div>
